stages:
  - test
  - release

variables:
  CHART_DIR: "."

lint-chart:
  stage: test
  image: alpine/helm:latest
  script:
    - helm lint $CHART_DIR
deploy-chart-http:
  stage: release
  image: alpine/helm:latest
  before_script:
    - apk add --no-cache curl
  script:
    - echo "Packaging chart..."
    - helm package .

    - |
      curl --fail-with-body --request POST \
        --user gitlab-ci-token:$CI_JOB_TOKEN \
        --form "chart=@$(ls *.tgz)" \
        "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/helm/api/stable/charts"
  rules:
    - if: $CI_COMMIT_TAG
stages:
  - test
  - release

variables:
  # CHANGE THIS: The path to your chart folder inside the repo
  CHART_DIR: "."

lint-chart:
  stage: test
  image: alpine/helm:latest
  script:
    - helm lint $CHART_DIR
deploy-chart-http:
  stage: release
  image: alpine/helm:latest
  # We need curl, so we install it before running the script
  before_script:
    - apk add --no-cache curl
  script:
    - echo "Packaging chart..."
    # 1. Package the chart (creates a .tgz file)
    - helm package .

    # 2. Upload using your curl command
    # We use $(ls *.tgz) to dynamically grab the file we just created
    - |
      curl --fail-with-body --request POST \
        --user gitlab-ci-token:$CI_JOB_TOKEN \
        --form "chart=@$(ls *.tgz)" \
        "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/helm/api/stable/charts"

  # Run only when a tag is pushed (keeps your registry clean)
  rules:
    - if: $CI_COMMIT_TAG
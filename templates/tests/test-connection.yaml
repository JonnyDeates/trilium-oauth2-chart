apiVersion: v1
kind: Pod
metadata:
  name: {{ include "trilium-oauth2-chart.fullname" . }}-ingress-test
  labels:
    app: {{ include "trilium-oauth2-chart.fullname" . }}-ingress-test
  annotations:
    "helm.sh/hook": test
    "helm.sh/hook-delete-policy": hook-succeeded,hook-failed
spec:
  restartPolicy: Never
  containers:
    - name: curl
      image: alpine/curl:latest
      command: ["/bin/sh", "-c"]
      args:
        - |
          set -e
          # Wait for the Ingress to be ready
          for i in {1..30}; do
            if curl -s -o /dev/null -w "%{http_code}" https://{{ .Values.ingress.host }} | grep -q 302; then
              echo "Ingress reachable"
              exit 0
            fi
            echo "Waiting for Ingressâ€¦ ($i/30)"
            sleep 2
          done
          echo "Ingress not reachable after 30 attempts" >&2
          exit 1
{{- if .Values.backup.enabled -}}
apiVersion: v1
kind: Pod
metadata:
  name: "{{ include "trilium-oauth2-chart.fullname" . }}-test-secret"
  labels:
    {{- include "trilium-oauth2-chart.labels" . | nindent 4 }}
  annotations:
    "helm.sh/hook": test
spec:
  containers:
    - name: secret-checker
      image: "alpine:latest"
      command: ['/bin/sh', '-c']
      args:
        - |
          echo "Checking for SSH key file..."
          if [ -f "/etc/ssh-key/{{ .Values.backup.sshKeyFileName | default "id_rsa" }}" ]; then
            echo "SUCCESS: Secret is mounted and key file exists."
            exit 0
          else
            echo "FAILURE: Key file not found."
            exit 1
          fi
      volumeMounts:
        - name: ssh-key
          mountPath: "/etc/ssh-key"
          readOnly: true
  volumes:
    - name: ssh-key
      secret:
        secretName: {{ required "A valid .Values.sshSecretName entry required!" .Values.backup.sshSecretName }}
        optional: false # This forces the pod to fail if secret is missing
  restartPolicy: Never
{{- end -}}